{% extends 'YSE_App/base.html' %}
{% load static from staticfiles %}

{% block styles %}
	<!-- include Aladin Lite CSS file in the head section of your page -->
	<link rel="stylesheet" href="//aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css" />
	<link rel="stylesheet" href="{% static 'YSE_App/bower_components/select2/dist/css/select2.min.css' %}">
	<link rel="stylesheet" href="{% static 'YSE_App/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

<!-- Content Header (Page header) -->
{% block content_header %}
	<h1>
		{{transient.name}}<br/>
		<small><a href="{% url 'index' %}">Back</a></small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="{% url 'dashboard' %}"><i class="fa fa-dashboard"></i> Home</a></li>
		<li>{{transient.name}}</li>
	</ol>
{% endblock %}

<!-- Main content -->
{% block content %}

	<div class="row">
		<div class="col-xs-6">
			<div class="box box-primary">
				<div class="box-header">
					<h3 class="box-title">Transient Detail</h3>
					<a target="_blank" href="{% url 'admin:YSE_App_transient_change' transient.id %}">(Edit)</a>
				</div>
				<div class="box-body">
					<!-- 3 col -->
					<div class="col-xs-4">
						<div class="form-group">
							<strong>R.A./Dec (2000)</strong>
							<p class="text-muted">
								{{ transient.CoordString.0 }}&nbsp;&nbsp;&nbsp;{{ transient.CoordString.1 }}<br>
								<small>{{ transient.RADecimalString }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ transient.DecDecimalString }}</small>
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Disc. Date (UTC)</strong>
							<p class="text-muted">
								{% if first_magdate %}
									{{ first_magdate }}
								{% else %}
									Unknown
								{% endif %}
							</p>
							<br>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Status</strong>
							<p class="text-muted">{{ transient.status }}</p>
							<br>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Redshift</strong>
							<p class="text-muted">
								{% if transient.redshift %}
									{{ transient.redshift }}
										{% if transient.redshift_err %}
											+/- {{ transient.redshift_err }}
										{% endif %}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Best Spec. Class</strong>
							<p class="text-muted">
								{% if transient.best_spec_class %}
									{{ transient.best_spec_class }}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>TNS Spec. Class</strong>
							<p class="text-muted">
								{% if transient.TNS_spec_class %}
									{{ transient.TNS_spec_class }}
								{% else %}
									None
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>MW E(B-V)</strong>
							<p class="text-muted">
								{% if transient.mw_ebv %}
									{{ transient.mw_ebv }}
									{% if transient.mw_ebv >= 0.2 %}
										&nbsp;<b class="text-red">(warning!)</b>
									{% endif %}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Discovery Group</strong>
							<p class="text-muted">
								{{ transient.obs_group.name }}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Alternative Names</strong>
							<p class="text-muted">
								{% if alt_names %}
									{% for alt_name in alt_names %}
										{{ alt_name }}<br>
									{% endfor %}
								{% else %}
									None
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Internal Survey</strong>
							<p class="text-muted">
								{% if transient.internal_survey %}
									{{ transient.internal_survey }}
								{% else %}
									None
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>ANTARES Class.</strong>
							<p class="text-muted">
								{% if transient.antares_classification %}
									{{ transient.antares_classification }}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Is in K2 Field?</strong>
							<p><a target="_blank" href="http://api.keplerscience.org/is-k2-observing?ra={{ transient.ra }}&dec={{ transient.dec }}">Go to K2 API</a></p>
						</div>
					</div>
					<div class="col-xs-12">
						<hr>
						<h4>Photometric Summary</h4>
						<table class="table table-bordered table-striped">
							<thead>
								<tr>
									<th></th>
									<th>Date</th>
									<th>Mag</th>
									<th>Mag Lim</th>
									<th>Filter</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Disc Mag</td>
									<td>{{ first_magdate }}</td>
									<td>{{ first_mag }}</td>
									<td></td>
									<td>{{ first_filter }}</td>
								</tr>
								<tr>
									<td>Last Non-detection</td>
									<td>{{ transient.non_detect_date }}</td>
									<td></td>
									<td>{{ transient.non_detect_limit }}</td>
									<td>{{ transient.non_detect_band }}</td>
								</tr>
								<tr>
									<td>Recent Mag</td>
									<td>{{ recent_magdate }}</td>
									<td>{{ recent_mag }}</td>
									<td></td>
									<td>{{ recent_filter }}</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<div class="col-xs-6">
			<div class="box box-primary">
				<div class="box-header">
					<h3 class="box-title">Host Detail &amp; External Resources</h3>
					{% if transient.host %}
						<a target="_blank" href="{% url 'admin:YSE_App_host_change' transient.host.id %}">(Edit)</a>
					{% endif %}
				</div>
				<div class="box-body">
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Host Name</strong>
							<p class="text-muted">
								{% if transient.host %}
									{% if transient.host.name %}
										{{ transient.host.name }}
									{% endif %}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>R.A./Dec (2000)</strong>
							<p class="text-muted">
								{% if transient.host %}
									{{ transient.host.CoordString.0 }}&nbsp;&nbsp;&nbsp;{{ transient.host.CoordString.1 }}<br>
								<small>{{ transient.host.RADecimalString }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ transient.host.DecDecimalString }}</small>
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<div class="col-xs-4">
						<div class="form-group">
							<strong>Redshift</strong>
							<p class="text-muted">
								{% if transient.host %}
									{% if transient.host.redshift %}
										{{ transient.host.redshift }}

										{% if transient.host.redshift_err %}
											+/- {{ transient.host.redshift_err }}
										{% endif %}
									{% endif %}
								{% else %}
									Unknown
								{% endif %}
							</p>
						</div>
					</div>
					<!-- Start 2 column -->
					<div class="col-xs-12">
						<hr>
					</div>
					<div class="col-xs-6">
						<div class="form-group">
							<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
								<ol class="carousel-indicators">
									<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
									<li data-target="#carousel-example-generic" data-slide-to="1" class=""></li>
									<li data-target="#carousel-example-generic" data-slide-to="2" class=""></li>
								</ol>
								<div class="carousel-inner">
									<div class="item active">
										<strong>SDSS Footprint</strong>
										<div>
											<a href="http://skyserver.sdss3.org/public/en/tools/chart/navi.aspx?opt=G&amp;ra={{ transient.ra }}&amp;dec={{ transient.dec }}&amp;scale=0.1981" target="_blank" title="Link to SDSS Navigate Tool" class="sdss-image-link">
												<img src="http://skyservice.pha.jhu.edu/DR14/ImgCutout/getjpeg.aspx?ra={{ transient.ra }}&dec={{ transient.dec }}&scale=0.5&width=200&height=200&opt=G&query=&Grid=on " style='width:240px' border="0">
											</a>
										</div>
									</div>
									<div class="item">
										<strong>DSS Footprint (Aladin)</strong>
										<div id="aladin-lite-div" style="width:240px;height:240px;"></div>
									</div>
									<div class="item">
										<strong>Pan-STARRS Footprint</strong>
										<div>
											{% if jpegurl %}
												<a href="http://ps1images.stsci.edu/cgi-bin/ps1cutouts?pos={{ transient.ra }}%2B{{ transient.dec }}&amp;filter=color" class="ps1-thumb" title="Link to PanSTARRS-1" target="_blank">
													<img src="{{ jpegurl }}" style='width:240px' alt="" />
												</a>
											{% else %}
												<p class="text-muted">Coordinates are outside the PS1 footprint</p>
											{% endif %}
										</div>
									</div>
								</div>
								<a class="left carousel-control" href="#carousel-example-generic" data-slide="prev">
									<span class="fa fa-angle-left"></span>
								</a>
								<a class="right carousel-control" href="#carousel-example-generic" data-slide="next">
									<span class="fa fa-angle-right"></span>
								</a>

							</div>
						</div>
					</div>
					<div class="col-xs-6">
						<div class="col-xs-12">
							<div class="form-group">
								<strong>External Links</strong>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="https://wis-tns.weizmann.ac.il/object/{{ transient.name }}" target="_blank">TNS</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://nedwww.ipac.caltech.edu/cgi-bin/nph-objsearch?ra={{ transient.ra }}&dec={{ transient.dec }}d&radius=10.0&search_type=Near+Position+Search" target="_blank">NED</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://simbad.u-strasbg.fr/simbad/sim-coo?protocol=html&amp;NbIdent=1&amp;Radius=1&amp;Radius.unit=arcmin&amp;CooFrame=FK5&amp;CooEpoch=2000&amp;CooEqui=2000&amp;Coord={{ transient.ra }}+{{ transient.dec }}" target="_blank">SIMBAD</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://vizier.u-strasbg.fr/viz-bin/VizieR?-source=&-out.add=_r&-out.add=_RAJ%2C_DEJ&-sort=_r&-to=&-out.max=20&-meta.ucd=2&-meta.foot=1&-c={{ transient.ra }}+{{ transient.dec }}&-c.rs=10" target="_blank">VizieR</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://irsa.ipac.caltech.edu/applications/wise/#id=Hydra_wise_wise_1&RequestClass=ServerRequest&DoSearch=true&intersect=CENTER&subsize=0.16666666800000002&mcenter=all&schema=allsky-4band&dpLevel=3a&band=1,2,3,4&UserTargetWorldPt={{ transient.ra }};{{ transient.dec }};EQ_J2000&SimpleTargetPanel.field.resolvedBy=nedthensimbad&preliminary_data=no&coaddId=&projectId=wise&searchName=wise_1&shortDesc=Position&isBookmarkAble=true&isDrillDownRoot=true&isSearchResult=true" target="_blank">WISE</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://archive.stsci.edu/cgi-bin/dss_search?h=5.0&w=5.0&f=fits&v=poss2ukstu_red&r={{ transient.ra }}d&d=+{{ transient.dec }}2d&e=J2000&c=none" target="_blank">DSS</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="form-group">
								<a class="btn btn-block btn-primary" href="http://adsabs.harvard.edu/cgi-bin/nph-abs_connect?db_key=AST&db_key=PRE&qform=AST&arxiv_sel=astro-ph&arxiv_sel=cond-mat&arxiv_sel=cs&arxiv_sel=gr-qc&arxiv_sel=hep-ex&arxiv_sel=hep-lat&arxiv_sel=hep-ph&arxiv_sel=hep-th&arxiv_sel=math&arxiv_sel=math-ph&arxiv_sel=nlin&arxiv_sel=nucl-ex&arxiv_sel=nucl-th&arxiv_sel=physics&arxiv_sel=quant-ph&arxiv_sel=q-bio&sim_query=YES&ned_query=YES&adsobj_query=YES&obj_req=YES&aut_logic=OR&obj_logic=OR&author=&object={{ transient.ra }}%20+{{ transient.dec }}%3A0.002778%0D%0A{{ transient.name }}&start_mon=&start_year=&end_mon=&end_year=&ttl_logic=OR&title=&txt_logic=OR&text=&nr_to_return=200&start_nr=1&jou_pick=ALL&ref_stems=&data_and=ALL&group_and=ALL&start_entry_day=&start_entry_mon=&start_entry_year=&end_entry_day=&end_entry_mon=&end_entry_year=&min_score=&sort=SCORE&data_type=SHORT&aut_syn=YES&ttl_syn=YES&txt_syn=YES&aut_wt=1.0&obj_wt=1.0&ttl_wt=0.3&txt_wt=3.0&aut_wgt=YES&obj_wgt=YES&ttl_wgt=YES&txt_wgt=YES&ttl_sco=YES&txt_sco=YES&version=1">ADS</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-xs-12">
			<div class="nav-tabs-custom">
				<ul class="nav nav-tabs">
					<li class="active"><a href="#followup_tab" data-toggle="tab">Follow-up</a></li>
					<li><a href="#resources_tab" data-toggle="tab">Resources</a></li>
					<li><a href="#photometry_tab" data-toggle="tab">Detailed Photometry</a></li>
					<li><a href="#spectra_tab" data-toggle="tab">Spectra</a></li>
				</ul>
				<div class="tab-content">
					<div class="active tab-pane" id="followup_tab">
						<div class="row">
							<div class="col-xs-6">
								<input type="hidden" id="transient_pk" value="{{ transient.id }}"/>
								{% include "YSE_App/form_snippets/transient_followup_form.html" with form=transient_followup_form %}
							</div>
							<div class="col-xs-6">
								<input type="hidden" id="followup_pk" />
								{% include "YSE_App/form_snippets/transient_observation_task_form.html" with form=transient_observation_task_form %}
							</div>
						</div>
						<div class="row">
							<div id="followup_container">
								{% for f in followups %}
									<div class="col-xs-12">
										{% if forloop.counter <= 1 %}
											<div class="followupbox box box-primary">
										{% else %}
											<div class="followupbox box box-primary collapsed-box">
										{% endif %}
												<div class="box-header">
													<div class="col-xs-4">
														<h3 class="box-title">Follow-up (id: {{f.id}})</h3>
													</div>
													<div class="col-xs-4">
														<h3 class="box-title">Valid: {{ f.valid_start|date:"SHORT_DATE_FORMAT" }} - {{ f.valid_stop|date:"SHORT_DATE_FORMAT" }}</h3>
													</div>
													<div class="col-xs-4">
														<h3 style="float:right;padding-right:10px" class="box-title">Last Modified: {{f.modified_by}}</h3>
													</div>
													<div class="box-tools pull-right">

														{% if forloop.counter <= 1 %}
															<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
															</button>
														{% else %}
															<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i>
															</button>
														{% endif %}
													</div>
												</div>
												<div class="box-body">
													<table id="tbl_followup_{{f.id}}" class="table table-bordered table-striped">
														<thead>
															<tr>
																<th>Spec. Priority</th>
																<th>Phot. Priority</th>
																<th>Offset Star<br>RA</th>
																<th>Offset Star<br>DEC</th>
																<th>Offset North</th>
																<th>Offset East</th>
																<th>Attached Resource</th>
																<th>Status</th>
																<th>Action</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td>{{ f.spec_priority }}</td>
																<td>{{ f.phot_priority }}</td>
																<td>{{ f.offset_star_ra }}</td>
																<td>{{ f.offset_star_dec }}</td>
																<td>{{ f.offset_north }}</td>
																<td>{{ f.offset_east }}</td>
																<td>
																	{% if f.too_resource %}
																		{{ f.too_resource }}
																		<br>
																	{% endif %}
																	{% if f.classical_resource %}
																		{{ f.classical_resource }}
																		<br>
																	{% endif %}
																	{% if f.queued_resource %}
																		{{ f.queued_resource }}
																	{% endif %}
																</td>
																<td>{{ f.status }}</td>
																<td><a target='_blank' href="{% url 'admin:YSE_App_transientfollowup_change' f.id %}">Edit</a></td>
															</tr>
														</tbody>
													</table>
													<hr>
													<h4 class="box-title">Observation Tasks</h4>
													<table id="tbl_obs_followup_{{f.id}}" class="table table-bordered table-striped">
														<thead>
															<tr>
																<th>ID</th>
																<th>Obs.</th>
																<th>Tel.</th>
																<th>Inst.</th>
																<th>Desired Obs.<br>Date (UTC)</th>
																<th>Actual Obs.<br>Date (UTC)</th>
																<th>Exp.<br>Time</th>
																<th>Desc.</th>
																<th># of<br>Exp.</th>
																<th>Config. Name</th>
																<th>Config. Detail</th>
																<th>Status</th>
																<th>Last<br>Modified By</th>
																<th>Action</th>
															</tr>
														</thead>
														<tbody>
															{% for o in f.observation_set.all %}
																<tr>
																	<td>{{ o.id }}</td>
																	<td>{{ o.instrument_config.instrument.telescope.observatory.name }}</td>
																	<td>{{ o.instrument_config.instrument.telescope.name }}</td>
																	<td>{{ o.instrument_config.instrument.name }}</td>
																	<td>{{ o.desired_obs_date }}</td>
																	<td>{{ o.actual_obs_date }}</td>
																	<td>{{ o.exposure_time }}</td>
																	<td>{{ o.description }}</td>
																	<td>{{ o.number_of_exposures }}</td>
																	<td>{{ o.instrument_config.name }}</td>
																	<td>
																		<ul>
																			{% for c in o.instrument_config.configelement_set.all %}
																				<li>{{ c.name }}</li>
																			{% endfor %}
																		</ul>
																	</td>
																	<td>{{ o.status }}</td>
																	<td>{{ o.modified_by }}</td>
																	<td><a target='_blank' href="{% url 'admin:YSE_App_transientobservationtask_change' o.id %}">Edit</a></td>
																</tr>
															{% endfor %}
															<tr>
																<td colspan='13'></td>
																<td><b><a class="add_task" followup_id="{{f.id}}" href="#">Add</a></b></td>
															</tr>
														</tbody>
													</table>
												</div>
											</div>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
					<div class="tab-pane" id="resources_tab">
						<div class="row">
							<div class="col-xs-12">
								<h4>Current UTC Time: <strong>{{ nowtime }}</strong></h4>
								<ul>
								  <!--<li><a target="_blank" href="{% url 'finderchart' transient.id %}">Generate Finder Chart</a></li>-->
								</ul>

								<!-- {% static "" as baseUrl %}
								<img src="{{baseUrl}}/YSE_App/images/findercharts/{{transient.name}}/{{transient.name}}.finder.png" style='width:240px' alt="" /> -->
								<br><br>
							</div>
							<div class="col-xs-12">
								<b>Classical Resources</b><br>
								<table id="telescope_tbl" class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>Telescope (Classical)</th>
											<th>Next Obs. Night</th>
											<th>Rise Time (UT)</th>
											<th>Set Time (UT)</th>
											<th>Moon Angle</th>
											<th>Airmass Plot</th>
										</tr>
									</thead>
									<tbody>
										{% for telescope in telescope_list %}
											{% for obsnight in observing_nights %}
												{% if obsnight.0.happening_soon and obsnight.0.telescope == telescope.tostring and obsnight.1 %}
													<tr>
														<td>{{ telescope }}</td>
														<td>{{ obsnight.0.obs_date }}</td>
														<td>{{ obsnight.0.rise_time }}</td>
														<td>{{ obsnight.0.set_time }}</td>
														<td>{{ obsnight.0.moon_angle }} deg</td>
														<td><img src="{% url 'airmassplot' transient.id obsnight.0.id telescope.id %}" style='width:240px' alt="" /><br></td>
													</tr>
												{% endif %}
											{% endfor %}
										{% endfor %}
									</tbody>
								</table>
							</div>
							<div class="col-xs-12">
								<b>ToO Resources</b><br>
								<table id="telescope_tbl" class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>Telescope (ToO)</th>
											<th>ToO Hours Remaining</th>
											<th>Rise Time (UT)</th>
											<th>Set Time (UT)</th>
											<th>Moon Angle</th>
											<th>Airmass Plot</th>
										</tr>
									</thead>
									<tbody>
										{% for too_resource in too_resource_list %}
											{% if too_resource.deltahours > 0 %}
												<tr>
													<td>{{ too_resource.telescope }}</td>
													<td>{{ too_resource.deltahours }}</td>
													<td>{{ too_resource.rise_time }}</td>
													<td>{{ too_resource.set_time }}</td>
													<td>{{ too_resource.moon_angle }} deg</td>
													<td><img src="{% url 'airmassplot' transient.id 0 too_resource.telescope_id %}" style='width:240px' alt="" /><br></td>
												</tr>
											{% endif %}
										{% endfor %}
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="photometry_tab">
						<h4>Photometry for {{transient.name}}</h4>
						<td><img src="{% url 'lightcurveplot' transient.id %}" style='width:240px' alt="" /><br></td>
					</div>
					<div class="tab-pane" id="spectra_tab">
						<h4>Spectra for {{transient.name}}</h4>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}

	<script type="text/javascript" src="//aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js" charset="utf-8"></script>

	<script src="{% static 'YSE_App/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
	<script src="{% static 'YSE_App/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>

	<script>
		$(function() {
			$('#example1').DataTable({
				  'paging'      : false,
				  'lengthChange': false,
				  'searching'   : false,
				  'ordering'    : false,
				  'info'        : false,
				  'autoWidth'   : false
				})
			// $('#example2').DataTable({
			//   'paging'      : true,
			//   'lengthChange': false,
			//   'searching'   : false,
			//   'ordering'    : true,
			//   'info'        : true,
			//   'autoWidth'   : false
			// })

			var aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov:0.017, target: "{{transient.ra}} {{transient.dec}}"});

			$('#follow_date_range').daterangepicker({
				timePicker24Hour: true,
				timePicker: true,
				timePickerIncrement: 1,
				format: 'MM/DD/YYYY HH:mm',
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				}
			});

			$('#obs_task_desired_picker').daterangepicker({
				timePicker24Hour: true,
				timePicker: true,
				timePickerIncrement: 1,
				singleDatePicker: true,
				format: 'MM/DD/YYYY HH:mm',
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				}
			});

			$('#obs_task_actual_picker').daterangepicker({
				timePicker24Hour: true,
				timePicker: true,
				timePickerIncrement: 1,
				singleDatePicker: true,
				format: 'MM/DD/YYYY HH:mm',
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				}
			});
			// Clear initial value
			$('#obs_task_actual_picker').val('');

			// Initialize daterange
			fdr_picker = $('#follow_date_range').data('daterangepicker')
			$('#valid_start').val(fdr_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			$('#valid_stop').val(fdr_picker.endDate.format("YYYY-MM-DD HH:mm:00"))

			// Intialize Desired Obs Date. Don't initialize Actual Obs Date...
			otd_picker = $('#obs_task_desired_picker').data('daterangepicker')
			$('#desired_obs_date').val(otd_picker.startDate.format("YYYY-MM-DD HH:mm:00"))

			//Respond to daterange change events
			$('#obs_task_desired_picker').on('apply.daterangepicker', function(ev, picker) {
				$('#desired_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			});
			$('#obs_task_actual_picker').on('apply.daterangepicker', function(ev, picker) {
				$('#actual_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			});
			$('#follow_date_range').on('apply.daterangepicker', function(ev, picker) {
				$('#valid_start').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
				$('#valid_stop').val(picker.endDate.format("YYYY-MM-DD HH:mm:00"))
			});

			// Submit post on submit
			$('#add_transient_followup').on('submit', function(event){
				event.preventDefault();
				add_transient_followup();
			});

			function ToggleObservationTaskForm(followup_id,expand)
			{
				if (expand) {
					//Set the hidden follow-up field in the form
					$('#observation_task_followup_pk').val(followup_id);

					//Enable the form
					$('#add_transient_observation_task_fieldset').attr('disabled', false)

					//Clear old messages & set new messages
					$('#add_transient_observation_task_info > ul').empty();
					$("#add_transient_observation_task_info ul").append("<li>Adding task for <b>Follow-up (id: " + followup_id + ")</b></li>");

					//Toggle message divs
					$("#add_transient_observation_task_warning").hide();
					$("#add_transient_observation_task_info").show();

					//If the form is hidden, show the form
					if ($("#add_transient_observation_task_btn").parent().parent().parent().hasClass('collapsed-box')) {
						$("#add_transient_observation_task_btn").trigger("click")
					}
				} else {
					//Toggle message divs
					$("#add_transient_observation_task_warning").show();
					$("#add_transient_observation_task_info").hide();

					//Clear old messages
					$('#add_transient_observation_task_info > ul').empty();

					//Disable the form
					$('#add_transient_observation_task_fieldset').attr('disabled', true)

					//Unset the hidden follow-up field in the form
					$('#observation_task_followup_pk').val("");
				}
			}

			$("#add_transient_observation_task_btn").on('click',function(event){
				//If the form is hidden, show the form
				if (!$("#add_transient_observation_task_btn").parent().parent().parent().hasClass('collapsed-box')) {
					ToggleObservationTaskForm("",false);
				}
			});

			$('.add_task').on('click', function(event){
				event.preventDefault();
				var followup_id = $(this).attr('followup_id');
				ToggleObservationTaskForm(followup_id,true)
			});

			$('.followup_edit').on('click', function(event){
				event.preventDefault();
				var followup_id = $(this).attr('followup_id');

				//Set all form fields
				//Expose form
				alert("Edit: " + followup_id + "!");
			});

			$('#add_transient_observation_task').on('submit', function(event){
				event.preventDefault();
				add_transient_observation_task();
			});

			function add_transient_observation_task() {
				//Serialize the form data and make POST
				var data = $('#add_transient_observation_task').serialize()
				var followup_id = $('#observation_task_followup_pk').val()
				data = (data + "&followup=" + followup_id)

				$.ajax({
					url : "{% url 'add_transient_observation_task' %}", // the endpoint
					type : "POST", // http method
					data : data, // data sent with the post request

					// handle a successful response
					success : function(json) {

						// Required fields
						var obs_task_pk = json.data["id"]
						var status_id = json.data["status_id"]
						var status_name = json.data["status_name"]
						var instrument_config = json.data["instrument_config"]
						var exposure_time = json.data["exposure_time"]
						var number_of_exposures = json.data["number_of_exposures"]
						var desired_obs_date = json.data["desired_obs_date"]
						var observatory = json.data["observatory"]
						var telescope = json.data["telescope"]
						var instrument = json.data["instrument"]
						var config_eles = json.data["config_eles"]
						var modified_by = json.data["modified_by"]

						if (!obs_task_pk || !status_id || !status_name ||
							!instrument_config || !exposure_time || !number_of_exposures || !desired_obs_date || !observatory || !telescope || !instrument || !modified_by || !config_eles) {
							alert("Required fields for `Transient Observation Task` not found! Please contact administrator. Exiting...")
							throw "Missing required fields from ``AddTransientObservationTaskFormView"
						}

						var actual_obs_date = json.data["actual_obs_date"] ? json.data["actual_obs_date"] : "None"
						var description = json.data["description"] ? json.data["description"] : ""

						// Construct HTML to append container
						var taskHTML = "<tr>" +
							"<td>" + obs_task_pk + "</td>" +
							"<td>" + observatory + "</td>" +
							"<td>" + telescope + "</td>" +
							"<td>" + instrument + "</td>" +
							"<td>" + desired_obs_date + "</td>" +
							"<td>" + actual_obs_date + "</td>" +
							"<td>" + exposure_time + "</td>" +
							"<td>" + description + "</td>" +
							"<td>" + number_of_exposures + "</td>" +
							"<td>" + instrument_config + "</td>" +
							"<td>" + config_eles + "</td>" +
							"<td>" + status_name + "</td>" +
							"<td>" + modified_by + "</td>" +
							"<td><a target='_blank' href='{% url 'admin:YSE_App_transientobservationtask_changelist' %}" + obs_task_pk + "/change/'>Edit</a></td>" +
							"</tr>"

							var rows = $("#tbl_obs_followup_" + followup_id + " > tbody")
							$(rows).prepend(taskHTML)

							//Append the hidden followup field to the payload
							//Parse and write data to correct grid
							//Disable form
							//Remove info-text and restore warning text
							//Minimize form
							//Clear form fields

							// Close & reset form box
							$("#add_transient_observation_task_btn").trigger("click")
							$('#add_transient_observation_task')[0].reset();

							// Re-initialize the datepicker
							$('#desired_obs_date').val("")
							$('#actual_obs_date').val("")
							$('#obs_task_desired_picker').daterangepicker({
								timePicker24Hour: true,
								timePicker: true,
								timePickerIncrement: 1,
								singleDatePicker: true,
								format: 'MM/DD/YYYY HH:mm',
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});
							$('#obs_task_actual_picker').daterangepicker({
								timePicker24Hour: true,
								timePicker: true,
								timePickerIncrement: 1,
								singleDatePicker: true,
								format: 'MM/DD/YYYY HH:mm',
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});

							// Re-Initialize daterange
							otd_picker = $('#obs_task_desired_picker').data('daterangepicker')
							$('#desired_obs_date').val(otd_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							// Clear initial value for optional field
							$('#obs_task_actual_picker').val('');

							$('#obs_task_desired_picker').on('apply.daterangepicker', function(ev, picker) {
								$('#desired_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							});
							$('#obs_task_actual_picker').on('apply.daterangepicker', function(ev, picker) {
								$('#actual_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							});
					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						alert(xhr.status + ": " + xhr.responseText);
					}
				});
			}

			function add_transient_followup() {
				// Grab the form, and associate it with the current transient detail page
				var data = $('#add_transient_followup').serialize()
				var transient_id = $('#transient_pk').val()
				data = (data + "&transient=" + transient_id)

				$.ajax({
					url : "{% url 'add_transient_followup' %}", // the endpoint
					type : "POST", // http method
					data : data, // data sent with the post request

					// handle a successful response
					success : function(json) {

						// Required fields
						var followup_pk = json.data["id"]
						var status_id = json.data["status_id"]
						var status_name = json.data["status_name"]
						var valid_start = json.data["valid_start"]
						var valid_stop = json.data["valid_stop"]
						var modified_by = json.data["modified_by"]

						if (!followup_pk || !status_id || !status_name ||
							!valid_start || !valid_stop || !modified_by) {
							alert("Required fields for `Transient Followup` not found! Please contact administrator. Exiting...")
							throw "Missing required fields from ``AddTransientFollowupFormView"
						}

						var too_resource = json.data["too_resource"]
						var classical_resource = json.data["classical_resource"]
						var queued_resource = json.data["queued_resource"]

						var spec_priority = json.data["spec_priority"] ? json.data["spec_priority"] : "None"
						var phot_priority = json.data["phot_priority"] ? json.data["phot_priority"] : "None"
						var offset_star_ra = json.data["offset_star_ra"] ? json.data["offset_star_ra"] : "None"
						var offset_star_dec = json.data["offset_star_dec"] ? json.data["offset_star_dec"] : "None"
						var offset_north = json.data["offset_north"] ? json.data["offset_north"] : "None"
						var offset_east = json.data["offset_east"] ? json.data["offset_east"] : "None"

						// Construct date strings
						var start_date = new Date(valid_start)
						var end_date = new Date(valid_stop)
						var start_date_str = start_date.getUTCMonth() + "/" + start_date.getUTCDate() + "/" + start_date.getUTCFullYear()
						var end_date_str = end_date.getUTCMonth() + "/" + end_date.getUTCDate() + "/" + end_date.getUTCFullYear()

						// Construct associated resources
						var associated_resouces = "";
						if (too_resource) {
							associated_resouces = (associated_resouces + too_resource + "<br>")
						}
						if (classical_resource) {
							associated_resouces = (associated_resouces + classical_resource + "<br>")
						}
						if (queued_resource) {
							associated_resouces = (associated_resouces + queued_resource)
						}

						// Construct HTML to append container
						var followupHTML = "<div class='col-xs-12'>" +
							"<div class='followupbox box box-primary'>" +
							"<div class='box-header'>" +
							"<div class='col-xs-4'>" +
							"<h3 class='box-title'>Follow-up (id: " + followup_pk + ")</h3>" +
							"</div>" +
							"<div class='col-xs-4'>" +
							"<h3 class='box-title'>Valid: " + start_date_str + " - " + end_date_str + "</h3>" +
							"</div>" +
							"<div class='col-xs-4'>" +
							"<h3 style='float:right;padding-right:10px' class='box-title'>Last Modified: " + modified_by + "</h3>" +
							"</div>" +
							"<div class='box-tools pull-right'>" +
							"<button type='button' class='btn btn-box-tool' data-widget='collapse'><i class='fa fa-minus'></i></button>" +
							"</div>" +
							"</div>" +
							"<div class='box-body'>" +
							"<table id='tbl_followup_" + followup_pk + "' class='table table-bordered table-striped'>" +
							"<thead><tr><th>Spec. Priority</th><th>Phot. Priority</th><th>Offset Star<br>RA</th><th>Offset Star<br>DEC</th><th>Offset North</th><th>Offset East</th><th>Attached Resource</th><th>Status</th><th>Action</th></tr></thead>" +
							"<tbody><tr>" +
							"<td>" + spec_priority + "</td>" +
							"<td>" + phot_priority + "</td>" +
							"<td>" + offset_star_ra + "</td>" +
							"<td>" + offset_star_dec + "</td>" +
							"<td>" + offset_north + "</td>" +
							"<td>" + offset_east + "</td>" +
							"<td>" + associated_resouces + "</td>" +
							"<td>" + status_name + "</td>" +
							"<td><a target='_blank' href='{% url 'admin:YSE_App_transientfollowup_changelist' %}" + followup_pk + "/change/'>Edit</a></td>" +
							"</tr></tbody></table><hr>" +
							"<h4 class='box-title'>Observation Tasks</h4>" +
							"<table id='tbl_obs_followup_" + followup_pk + "' class='table table-bordered table-striped'>" +
							"<thead><tr>" +
							"<th>ID</th>" +
							"<th>Obs.</th>" +
							"<th>Tel.</th>" +
							"<th>Inst.</th>" +
							"<th>Desired Obs.<br>Date (UTC)</th>" +
							"<th>Actual Obs.<br>Date (UTC)</th>" +
							"<th>Exp.<br>Time</th>" +
							"<th>Desc.</th>" +
							"<th># of<br>Exposures</th>" +
							"<th>Config. Name</th>" +
							"<th>Config. Detail</th>" +
							"<th>Status</th>" +
							"<th>Last<br>Modified By</th>" +
							"<th>Action</th>" +
							"</tr></thead>" +
							"<tbody><tr><td colspan='13'></td><td><b><a class='add_task' followup_id='" + followup_pk + "' href='#'>Add</a></b></td></tr>" +
							"</tbody></table><br></div></div></div>"

							var container_collection = $("#followup_container > div")
							if (container_collection.length == 0) {
								$("#followup_container").append(followupHTML)
							} else {
								$("#followup_container").prepend(followupHTML)
							}

							// Close & reset form box
							$("#add_transient_followup_btn").trigger("click")
							$('#add_transient_followup')[0].reset();

							// Re-initialize the datepicker
							$('#valid_start').val("")
							$('#valid_stop').val("")
							$('#follow_date_range').daterangepicker({
								timePicker24Hour: true,
								timePicker: true,
								timePickerIncrement: 1,
								format: 'MM/DD/YYYY HH:mm',
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});

							// Re-Initialize daterange
							fdr_picker = $('#follow_date_range').data('daterangepicker')
							$('#valid_start').val(fdr_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							$('#valid_stop').val(fdr_picker.endDate.format("YYYY-MM-DD HH:mm:00"))

							// Re-wire widget behavior
							$('.followupbox').boxWidget()
							$('.add_task').on('click', function(event){
								event.preventDefault();
								var followup_id = $(this).attr('followup_id');
								ToggleObservationTaskForm(followup_id,true)
							});
					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						alert(xhr.status + ": " + xhr.responseText);
					}
				});
			};

			// This function gets cookie with a given name
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}

			var csrftoken = getCookie('csrftoken');

			/*
			The functions below will create a header with csrftoken
			*/

			function csrfSafeMethod(method) {
				// these HTTP methods do not require CSRF protection
				return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}

			function sameOrigin(url) {
				// test that a given url is a same-origin URL
				// url could be relative or scheme relative or absolute
				var host = document.location.host; // host + port
				var protocol = document.location.protocol;
				var sr_origin = '//' + host;
				var origin = protocol + sr_origin;
				// Allow absolute or scheme relative URLs to same origin
				return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
				(url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
					// or any other URL that isn't scheme relative or absolute i.e relative.
					!(/^(\/\/|http:|https:).*/.test(url));
				}

				$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
						// Send the token to same-origin, relative URLs only.
						// Send the token only if the method warrants CSRF protection
						// Using the CSRFToken value acquired earlier
						xhr.setRequestHeader("X-CSRFToken", csrftoken);
					}
				}
			});
		});
	</script>
{% endblock %}
