{% extends 'YSE_App/base.html' %}
{% load static %}
{% load transient_detail_extras %}
{% load widget_tweaks %}

{% block styles %}
	<!-- include Aladin Lite CSS file in the head section of your page -->
	<link rel="stylesheet" href="//aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css" />
	<link rel="stylesheet" href="{% static 'YSE_App/bower_components/select2/dist/css/select2.min.css' %}">
	<link rel="stylesheet" href="{% static 'YSE_App/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css' %}">
{% endblock %}
	
<!-- Content Header (Page header) -->
{% block content_header %}
	<h1>
		{{transient.name}}<br/>
		<small><a href="{% url 'index' %}">Back</a></small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="{% url 'dashboard' %}"><i class="fa fa-dashboard"></i> Home</a></li>
		<li>{{transient.name}}</li>
	</ol>
{% endblock %}

<!-- Main content -->
{% block content %}

	<div class="row">
		<div class="col-xs-12">
			<div class="nav-tabs-custom">
				<ul class="nav nav-tabs">
					<li class="active"><a href="#summary_tab" data-toggle="tab">Summary</a></li>
					<li><a href="#followup_tab" data-toggle="tab">Follow-up</a></li>
					<li><a href="#resources_tab" data-toggle="tab">Resources</a></li>
					<li><a href="#photometry_tab" data-toggle="tab">Detailed Photometry</a></li>
					<li><a href="#spectra_tab" data-toggle="tab">Spectra</a></li>		
					<li><a href="#hst_tab" data-toggle="tab" id="hst_tab_header">HST Data</a></li>
					<li><a href="#chandra_tab" data-toggle="tab" id="chandra_tab_header">Chandra Data</a></li>
					{% if gw_candidate %}
						<li><a href="#gw_tab" data-toggle="tab" id="gw_tab_header">GW Info</a></li>
					{% endif %}
					<li><a href="#comments_tab" data-toggle="tab">Comments</a></li>
				</ul>
				<div class="tab-content">
					<div class="active tab-pane" id="summary_tab">
						<div class="row">
							<div class="col-xs-6">
								<div class="box box-primary">
									<div class="box-header">
										<h3 class="box-title">Transient Detail</h3>
										<a target="_blank" href="{% url 'admin:YSE_App_transient_change' transient.id %}">(Edit)</a>
									</div>
									<div class="box-body">
										<div class="col-xs-4">
											<div style="margin-top:10px;" class="form-group">
												<strong>R.A./Dec (2000)</strong>
												<p class="text-muted">
													{{ transient.CoordString.0 }}&nbsp;&nbsp;&nbsp;{{ transient.CoordString.1 }}<br>
													<small>{{ transient.RADecimalString }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ transient.DecDecimalString }}</small>
												</p>
											</div>
										</div>
										<div class="col-xs-3">
											<div style="margin-top:10px;" class="form-group">
												<strong>Disc. Date (UTC)</strong>
												<p class="text-muted">
													{% if first_magdate %}
														{{ first_magdate }}
													{% else %}
														Unknown
													{% endif %}
												</p>
												<br>
											</div>
										</div>
										<div class="col-xs-5">
											<div class="box box-default box-solid">
												<div class="box-header with-border">
													<strong style="float:left;margin-right:10px;">Status:</strong>
													<p style="float:left" id="transient_status_name" >{{ transient.status }}</p>
												</div>
												<div class="box-body">
													<div class="btn-group-horizontal">
														<button style="margin-bottom:5px;" type="button" data-status_id="{{ transient_status_follow.id }}" class="transientStatusChange btn btn-primary">{{ transient_status_follow.name }}</button>
														<button style="margin-bottom:5px;" type="button" data-status_id="{{ transient_status_watch.id }}" class="transientStatusChange btn btn-warning">{{ transient_status_watch.name }}</button>
														<button style="margin-bottom:5px;" type="button" data-status_id="{{ transient_status_ignore.id }}" class="transientStatusChange btn btn-danger">{{ transient_status_ignore.name }}</button>
														<div class="btn-group">
															<button style="margin-bottom:5px;" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
																<span class="caret"></span>
															</button>
															<ul class="dropdown-menu">
																{% for status in all_transient_statuses %}
																	<li><a data-status_id="{{ status.id }}" class="transientStatusChange" href="#">{{ status.name }}</a></li>
																{% endfor %}
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Redshift</strong>
												<p class="text-muted">
													{% if transient.redshift %}
														{{ transient.redshift }} 
															{% if transient.redshift_err %}
																+/- {{ transient.redshift_err }}
															{% endif %}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Best Spec. Class</strong>
												<p class="text-muted">
													{% if transient.best_spec_class %}
														{{ transient.best_spec_class }}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>TNS Spec. Class</strong>
												<p class="text-muted">
													{% if transient.TNS_spec_class %}
														{{ transient.TNS_spec_class }}
													{% else %}
														None
													{% endif %}
												</p>
												<br>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Galactic <i>l/b</i></strong>
												<p class="text-muted">
													{{ transient.CoordString|galcoordsl }}&nbsp;&nbsp;&nbsp;&nbsp;{{ transient.CoordString|galcoordsb }} 
												</p>
												<br>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>MW E(B-V)</strong>
												<p class="text-muted">
													{% if transient.mw_ebv %}
														{{ transient.mw_ebv }}
														{% if transient.mw_ebv >= 0.2 %}
															&nbsp;<b class="text-red">(warning!)</b>
														{% endif %}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										{% if transient.point_source_probability %}
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Point Source Prob.</strong>
												<p class="text-muted">
													{% if transient.point_source_probability %}
														{{ transient.point_source_probability }}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										{% endif %}
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Phot. Class</strong>
												<p class="text-muted">
													{{ transient.photo_class }}
												</p>
												<br>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>YSE Field</strong>
												<p class="text-muted">
													{% with transient.LikelyYSEField as ysefield %}
													{% if ysefield.0 %}
														{% if ysefield.3 %}
															{{ ysefield.0 }}, obs. {{ ysefield.3|floatformat:1 }} days ago
														{% else %}
															{{ ysefield.0}}, not observed
														{% endif %}
													{% else %}
													None
													{% endif %}
													{% endwith %}
												</p>
												<br>
											</div>
										</div>
										<div class="col-xs-12">
											<hr>
											<h4>Photometric Summary</h4>
											<table class="table table-bordered table-striped">
												<thead>
													<tr>
														<th></th>
														<th>Date</th>
														<th>Mag</th>
														<th>Mag Lim</th>
														<th>Filter</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td>Disc Mag</td>
														<td>{{ first_magdate }}</td>
														<td>{{ first_mag }}</td>
														<td></td>
														<td>{{ first_filter }}</td>
													</tr>
													<tr>
														<td>Last Non-detection</td>
														<td>{{ transient.non_detect_date }}</td>
														<td></td>
														<td>{{ transient.non_detect_limit }}</td>
														<td>{{ transient.non_detect_band }}</td>
													</tr>
													<tr>
														<td>Recent Mag</td>
														<td>{{ recent_magdate }}</td>
														<td>{{ recent_mag }}</td>
														<td></td>
														<td>{{ recent_filter }}</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
									<div>
										<input class="btn btn-block btn-primary" type="button" value="Download All Data" onclick="window.open('{% url 'download_data' transient.slug %}')">
									</div> 
								</div>
									<div class="col-xs-13">
										<div class="box box-primary">
											<div class="box-header">
												<h3 class="box-title">Photometry</h3>
											</div>
											&ensp;&nbsp;<div class="btn-group">
											<button style="margin-bottom:5px;" type="button" class="plotSALT2" id="salt2plot">
												Show SALT2 Fit</span>
											</button>
											<button style="margin-bottom:5px;" type="button" class="photdownload" onclick="window.open('{% url 'download_photometry' transient.slug %}')">
												Download Photometry</span>
											</button>
											</div>
											<div class="box-body" id="lcplot"></div>
										</div>
									</div>
								</div>
							<div class="col-xs-6">
								<div class="box box-primary">
									<div class="box-header">
										<h3 class="box-title">Host Detail &amp; External Resources</h3>
										{% if transient.host %}
											<a target="_blank" href="{% url 'admin:YSE_App_host_change' transient.host.id %}">(Edit)</a>
										{% endif %}
									</div>
									<div class="box-body">
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Host Name</strong>
												<p class="text-muted">
													{% if transient.host %}
														{% if transient.host.name %}
															{{ transient.host.name }}
														{% endif %}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>R.A./Dec (2000)</strong>
												<p class="text-muted">
													{% if transient.host %}
														{{ transient.host.CoordString.0 }}&nbsp;&nbsp;&nbsp;{{ transient.host.CoordString.1 }}<br>
													<small>{{ transient.host.RADecimalString }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ transient.host.DecDecimalString }}</small>
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										<div class="col-xs-4">
											<div class="form-group">
												<strong>Redshift</strong>
												<p class="text-muted">
													{% if transient.host %}
														{% if transient.host.redshift %}
															{{ transient.host.redshift }} 

															{% if transient.host.redshift_err %}
																+/- {{ transient.host.redshift_err }}
															{% endif %}
														{% endif %}
													{% else %}
														Unknown
													{% endif %}
												</p>
											</div>
										</div>
										<!--<div class="box-body">-->
											<div class="col-xs-12">
												<div class="form-group">
													<strong>Transient sep from likely host</strong>
													<p class="text-muted">
														{% if transient.host %}
															{{ transient.Separation }} arcsec<br>
														{% else %}
															Unknown
														{% endif %}
													</p>
												</div>
											</div>
										

										<!-- Start 2 column -->
										<div class="col-xs-12">
											<hr>
										</div>
										<div class="col-xs-6">
											<div class="form-group">
												<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
													<ol class="carousel-indicators">
														<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
														<li data-target="#carousel-example-generic" data-slide-to="1" class=""></li>
														<li data-target="#carousel-example-generic" data-slide-to="2" class=""></li>
														<li data-target="#carousel-example-generic" data-slide-to="3" class=""></li>
													</ol>
													<div class="carousel-inner">
														<div class="item active">
															<strong>SDSS Footprint</strong>
															<div>
																<a href="http://skyserver.sdss3.org/public/en/tools/chart/navi.aspx?opt=G&amp;ra={{ transient.ra }}&amp;dec={{ transient.dec }}&amp;scale=0.1981" target="_blank" title="Link to SDSS Navigate Tool" class="sdss-image-link">
																	<img src="http://skyservice.pha.jhu.edu/DR14/ImgCutout/getjpeg.aspx?ra={{ transient.ra }}&dec={{ transient.dec }}&scale=0.5&width=200&height=200&opt=G&query=&Grid=on " style='width:240px' border="0">
																</a>
															</div>
														</div>
														<div class="item">
															<strong>DSS Footprint (Aladin)</strong>
															<div id="aladin-lite-div" style="width:240px;height:240px;"></div>
														</div>
														<div class="item">
															<strong>Pan-STARRS Footprint</strong>
															<div id="ps1_image">
															</div>
														</div>
														<div class="item">
															<strong>Legacy Survey Image</strong>
															<div id="legacy_image">
															</div>
														</div>
													</div>
													<a class="left carousel-control" href="#carousel-example-generic" data-slide="prev">
														<span class="fa fa-angle-left"></span>
													</a>
													<a class="right carousel-control" href="#carousel-example-generic" data-slide="next">
														<span class="fa fa-angle-right"></span>
													</a>

												</div>
											</div>
										</div>
										<div class="col-xs-6">
											<div class="col-xs-12">
												<div class="form-group">
													<strong>External Links</strong>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="https://wis-tns.weizmann.ac.il/object/{{ transient.name }}" target="_blank">TNS</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://nedwww.ipac.caltech.edu/cgi-bin/nph-objsearch?ra={{ transient.ra }}&dec={{ transient.dec }}d&radius=10.0&search_type=Near+Position+Search" target="_blank">NED</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://simbad.u-strasbg.fr/simbad/sim-coo?protocol=html&amp;NbIdent=1&amp;Radius=1&amp;Radius.unit=arcmin&amp;CooFrame=FK5&amp;CooEpoch=2000&amp;CooEqui=2000&amp;Coord={{ transient.ra }}+{{ transient.dec }}" target="_blank">SIMBAD</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://vizier.u-strasbg.fr/viz-bin/VizieR?-source=&-out.add=_r&-out.add=_RAJ%2C_DEJ&-sort=_r&-to=&-out.max=20&-meta.ucd=2&-meta.foot=1&-c={{ transient.ra }}+{{ transient.dec }}&-c.rs=10" target="_blank">VizieR</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://irsa.ipac.caltech.edu/applications/wise/#id=Hydra_wise_wise_1&RequestClass=ServerRequest&DoSearch=true&intersect=CENTER&subsize=0.16666666800000002&mcenter=all&schema=allsky-4band&dpLevel=3a&band=1,2,3,4&UserTargetWorldPt={{ transient.ra }};{{ transient.dec }};EQ_J2000&SimpleTargetPanel.field.resolvedBy=nedthensimbad&preliminary_data=no&coaddId=&projectId=wise&searchName=wise_1&shortDesc=Position&isBookmarkAble=true&isDrillDownRoot=true&isSearchResult=true" target="_blank">WISE</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://archive.stsci.edu/cgi-bin/dss_search?h=5.0&w=5.0&f=fits&v=poss2ukstu_red&r={{ transient.ra }}d&d=+{{ transient.dec }}2d&e=J2000&c=none" target="_blank">DSS</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="http://adsabs.harvard.edu/cgi-bin/nph-abs_connect?db_key=AST&db_key=PRE&qform=AST&arxiv_sel=astro-ph&arxiv_sel=cond-mat&arxiv_sel=cs&arxiv_sel=gr-qc&arxiv_sel=hep-ex&arxiv_sel=hep-lat&arxiv_sel=hep-ph&arxiv_sel=hep-th&arxiv_sel=math&arxiv_sel=math-ph&arxiv_sel=nlin&arxiv_sel=nucl-ex&arxiv_sel=nucl-th&arxiv_sel=physics&arxiv_sel=quant-ph&arxiv_sel=q-bio&sim_query=YES&ned_query=YES&adsobj_query=YES&obj_req=YES&aut_logic=OR&obj_logic=OR&author=&object={{ transient.ra }}%20+{{ transient.dec }}%3A0.002778%0D%0A{{ transient.name }}&start_mon=&start_year=&end_mon=&end_year=&ttl_logic=OR&title=&txt_logic=OR&text=&nr_to_return=200&start_nr=1&jou_pick=ALL&ref_stems=&data_and=ALL&group_and=ALL&start_entry_day=&start_entry_mon=&start_entry_year=&end_entry_day=&end_entry_mon=&end_entry_year=&min_score=&sort=SCORE&data_type=SHORT&aut_syn=YES&ttl_syn=YES&txt_syn=YES&aut_wt=1.0&obj_wt=1.0&ttl_wt=0.3&txt_wt=3.0&aut_wgt=YES&obj_wgt=YES&ttl_wgt=YES&txt_wgt=YES&ttl_sco=YES&txt_sco=YES&version=1">ADS</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="https://asas-sn.osu.edu/" target="_blank">ASAS-SN</a>
												</div>
											</div>
											<div class="col-xs-6">
												<div class="form-group">
													<a class="btn btn-block btn-primary" href="https://mars.lco.global/?sort_value=jd&sort_order=desc&cone={{transient.ra}}%2C{{transient.dec}}%2C0.0014" target="_blank">ZTF Cone Search</a>
												</div>
											</div>
										</div>
									</div>
								<!--<div class="col-xs-13">-->
									<div class="box box-primary">
										<div class="box-header">
											<h3 class="box-title">Spectrum</h3>
										</div>
										{% if all_transient_spectra.count > 1 %}
										&ensp;&nbsp;<div class="btn-group">
											<button style="margin-bottom:5px;" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
												Select from {{ all_transient_spectra.count }} Spectra<span class="caret"></span>
											</button>
											<ul class="dropdown-menu">
												{% for spec in all_transient_spectra %}
													<li><a spec_plot-id="{{ spec.id }}" class="specPlotChange" href="#">{{ spec }} - {{ spec.instrument.name }}</a></li>
												{% endfor %}
											</ul>
										</div>
										{% endif %}
										<div class="box-body" id="specplot"></div>
										<p></p>
										<div class="row">
											<div class="col-xs-12">
												<input type="hidden" id="transient_pk" value="{{ transient.id }}"/>
												<input type="hidden" id="transient_ra" value="{{ transient.ra }}"/>
												<input type="hidden" id="transient_dec" value="{{ transient.dec }}"/>
												{% include "YSE_App/form_snippets/spectrum_upload_form.html" with form=spectrum_upload_form %}
											</div>
										</div>
										<p></p>
									</div>
																		<div class="box box-primary">
										<div class="box-header">
											<h3 class="box-title">Image Stamps</h3>
										</div>
																		              {% if transient.postage_stamp_file %}
              <div class="row">
                <div class="col-xs-4">
                  {% static "" as baseUrl %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_file as stampfile %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_file_fits as stampfitsfile %}
                  <a href="{% static stampfitsfile %}"><img src="{% static stampfile %}" style='width:170px' alt="" /></a>
                  {% endwith %}
                  {% endwith %}
                  <br><br>
                </div>
                <div class="col-xs-4">
                  {% static "" as baseUrl %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_ref as stampfile %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_ref_fits as stampfitsfile %}
                  <a href="{% static stampfitsfile %}"><img src="{% static stampfile %}" style='width:170px' alt="" /></a>
                  {% endwith %}
                  {% endwith %}
                  <br><br>
                </div>
                <div class="col-xs-4">
                  {% static "" as baseUrl %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_diff as stampfile %}
                  {% with "YSE_App/images/stamps/"|add:transient.postage_stamp_diff_fits as stampfitsfile %}
                  <a href="{% static stampfitsfile %}"><img src="{% static stampfile %}" style='width:170px' alt="" /></a>
                  {% endwith %}
                  {% endwith %}
                  <br><br>
                </div>
              </div>
              {% endif %}
          </div>
								</div>
								<div class="col-xs-12">
									<div class="col-xs-6">
										<div class="box box-default box-solid">
													<div class="box-header with-border">
														<strong>Available Tags</strong>
													</div>
													<div id="external-events" class="box-body">
														{% for tag in all_transient_tags %}
															<div data-tag_id="{{ tag.id }}" class="external-event bg-{{ tag.color }}">{{ tag.name }}</div>
														{% endfor %}
													</div>
												</div>

												<div class="box box-default box-solid">
													<div class="box-header with-border">
														<strong>Create Tag</strong>
													</div>
													<div class="box-body">
														<div class="btn-group" style="width: 100%; margin-bottom: 10px;">
															<ul class="fc-color-picker" id="color-chooser">
																{% for c in all_colors %}
																	<li><a data-color_id="{{ c.id }}" class="text-{{c.color}}" href="#"><i class="fa fa-square"></i></a></li>
																{% endfor %}
															</ul>
														</div>
														<div class="input-group">
															<input id="new-event" type="text" class="form-control" placeholder="Event Title">
															<div class="input-group-btn">
																<button id="add-new-event" type="button" class="btn btn-primary btn-flat">Add</button>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="col-xs-6">
												<div id="associated-events" class="box box-default box-solid">
													<div class="box-header with-border">
														<strong>Associated Tags</strong>
													</div>
													<div class="box-body" id="associated-events-list">
														{% for tag in assigned_transient_tags %}
															<div data-tag_id="{{ tag.id }}" class="external-event bg-{{ tag.color }}">{{ tag.name }}</div>
														{% endfor %}
													</div>
												</div>
											</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="followup_tab">
						<div class="row">
							<div class="col-xs-6">
								<input type="hidden" id="transient_pk" value="{{ transient.id }}"/>
								{% include "YSE_App/form_snippets/transient_followup_form.html" with form=transient_followup_form %}
							</div>
							<div class="col-xs-6">
								<input type="hidden" id="followup_pk" />
								{% include "YSE_App/form_snippets/transient_observation_task_form.html" with form=transient_observation_task_form %}
							</div>
						</div>
						<div class="row">
							<div id="followup_container">
								{% for f in followups %}
									<div class="col-xs-12">
										{% if forloop.counter <= 1 %}
											<div class="followupbox box box-primary">
										{% else %}
											<div class="followupbox box box-primary collapsed-box">
										{% endif %}
												<div class="box-header">
													<div class="col-xs-4">
														<h3 class="box-title">Follow-up (id: {{f.id}})</h3>
													</div>
													<div class="col-xs-4">
														<h3 class="box-title">Valid: {{ f.valid_start|date:"SHORT_DATE_FORMAT" }} - {{ f.valid_stop|date:"SHORT_DATE_FORMAT" }}</h3>
													</div>
													<div class="col-xs-4">
														<h3 style="float:right;padding-right:10px" class="box-title">Last Modified: {{f.modified_by}}</h3>
													</div>
													<div class="box-tools pull-right">

														{% if forloop.counter <= 1 %}
															<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
															</button>
														{% else %}
															<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i>
															</button>
														{% endif %}
													</div>
												</div>
												<div class="box-body">
													<table id="tbl_followup_{{f.id}}" class="table table-bordered table-striped">
														<thead>
															<tr>
																<th>Spec. Priority</th>
																<th>Phot. Priority</th>
																<th>Offset Star<br>RA</th>
																<th>Offset Star<br>DEC</th>
																<th>Offset North</th>
																<th>Offset East</th>
																<th>Attached Resource</th>
																<th>Status</th>
																<th>Comment</th>
																<th>Action</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td>{{ f.spec_priority }}</td>
																<td>{{ f.phot_priority }}</td>
																<td>{{ f.offset_star_ra }}</td>
																<td>{{ f.offset_star_dec }}</td>
																<td>{{ f.offset_north }}</td>
																<td>{{ f.offset_east }}</td>
																<td>
																	{% if f.too_resource %}
																		{{ f.too_resource }}
																		<br>
																	{% endif %}
																	{% if f.classical_resource %}
																		{{ f.classical_resource }}
																		<br>
																	{% endif %}
																	{% if f.queued_resource %}
																		{{ f.queued_resource }}
																	{% endif %}
																</td>
																<td>{{ f.status }}</td>
																<td>{{ f.comment }}</td>
																<td><a target='_blank' href="{% url 'admin:YSE_App_transientfollowup_change' f.id %}">Edit</a></td>
															</tr>
														</tbody>
													</table>
													<hr>
													<h4 class="box-title">Observation Tasks</h4>
													<table id="tbl_obs_followup_{{f.id}}" class="table table-bordered table-striped">
														<thead>
															<tr>
																<th>ID</th>
																<th>Obs.</th>
																<th>Tel.</th>
																<th>Inst.</th>
																<th>Desired Obs.<br>Date (UTC)</th>
																<th>Actual Obs.<br>Date (UTC)</th>
																<th>Exp.<br>Time</th>
																<th>Desc.</th>
																<th># of<br>Exp.</th>
																<th>Config. Name</th>
																<th>Config. Detail</th>
																<th>Status</th>
																<th>Last<br>Modified By</th>
																<th>Action</th>
															</tr>
														</thead>
														<tbody>
															{% for o in f.observation_set.all %}
																<tr>
																	<td>{{ o.id }}</td>
																	<td>{{ o.instrument_config.instrument.telescope.observatory.name }}</td>
																	<td>{{ o.instrument_config.instrument.telescope.name }}</td>
																	<td>{{ o.instrument_config.instrument.name }}</td>
																	<td>{{ o.desired_obs_date }}</td>
																	<td>{{ o.actual_obs_date }}</td>
																	<td>{{ o.exposure_time }}</td>
																	<td>{{ o.description }}</td>
																	<td>{{ o.number_of_exposures }}</td>
																	<td>{{ o.instrument_config.name }}</td>
																	<td>
																		<ul>
																			{% for c in o.instrument_config.configelement_set.all %}
																				<li>{{ c.name }}</li>
																			{% endfor %}
																		</ul>
																	</td>
																	<td>{{ o.status }}</td>
																	<td>{{ o.modified_by }}</td>
																	<td><a target='_blank' href="{% url 'admin:YSE_App_transientobservationtask_change' o.id %}">Edit</a></td>
																</tr>
															{% endfor %}
															<tr>
																<td colspan='13'></td>
																<td><b><a class="add_task" followup_id="{{f.id}}" href="#">Add</a></b></td>
															</tr>
														</tbody>
													</table>
												</div>
											</div>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
					<div class="tab-pane" id="resources_tab">
						<div class="row">
							<div class="col-xs-12">
								<h4>Current UTC Time: <strong>{{ nowtime }}</strong></h4>
								<ul>
								  <li><a target="_blank" href="{% url 'finderchart' transient.id %}">Generate Finder Chart</a></li>
								</ul>
								
								{% static "" as baseUrl %}
								{% with "YSE_App/images/findercharts/"|add:transient.name|add:"/"|add:transient.name|add:".finder.png" as finderfile %}
								<img src="{% static finderfile %}" style='width:240px' alt="" />
								{% endwith %}
								<br><br>
							</div>
							<div class="col-xs-12">
								<b>Classical Resources</b><br>
								<table id="telescope_tbl" class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>Telescope (Classical)</th>
											<th>Next Obs. Night</th>
											<th>Rise Time (UT)</th>
											<th>Set Time (UT)</th>
											<th>Moon Angle</th>
											<th>Airmass Plot</th>
										</tr>
									</thead>
                                    <tbody>
                                        {% for obsnight in observing_nights %}
                                            <tr>
                                                <td>{{ obsnight.resource.telescope }}</td>
                                                <td>{{ obsnight.obs_date }}</td>
                                                <td id="rise_time_{{ obsnight.id }}"></td>
                                                <td id="set_time_{{ obsnight.id }}"></td>
                                                <td id="moon_angle_{{ obsnight.id }}"></td>
                                                <td id="airmass_plot_table_{{obsnight.id}}_{{obsnight.resource.telescope.id}}"><button type="button" class="plotAirmass" telescope_id={{obsnight.resource.telescope.id}} resource_id="{{obsnight.resource.telescope.id}}" obsnight_id="{{obsnight.id}}">Show Plot</button></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
								</table>
							</div>
							<div class="col-xs-12">
								<b>ToO Resources</b><br>
								<table id="telescope_tbl" class="table table-bordered table-hover">
									<thead>
										<tr>
											<th>Telescope (ToO)</th>
											<th>ToO Hours Remaining</th>
											<th>Rise Time (UT)</th>
											<th>Set Time (UT)</th>
											<th>Moon Angle</th>
											<th>Airmass Plot</th>
										</tr>
									</thead>
                                    <tbody>
                                        {% for too_resource in too_resource_list %}
                                            <tr>
                                                <td>{{ too_resource.telescope }}</td>
                                                <td id="delta_too_hours_{{too_resource.id}}"></td>
                                                <td id="tonight_rise_time_{{too_resource.id}}"></td>
                                                <td id="tonight_set_time_{{too_resource.id}}"></td>
                                                <td id="tonight_moon_angle_{{too_resource.id}}"></td>
                                                <td id="airmass_plot_table_0_{{too_resource.id}}"><button type="button" class="plotAirmass" telescope_id={{too_resource.telescope.id}} resource_id="{{too_resource.id}}" obsnight_id="0">Show Plot</button></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="photometry_tab">
						<div>
										<input class="btn btn-block btn-primary" type="button" value="Download All Data" onclick="window.open('{% url 'download_data' transient.slug %}')">
									</div>
						<h4>Photometry for {{transient.name}}</h4>

						<table class="table table-bordered table-striped">
												<thead>
													<tr>
														<th>Date</th>
														<th>Mag</th>
														<th>Mag Error</th>
														<th>Filter</th>
														<th>Instrument</th>
													</tr>
												</thead>
												<tbody>
												{%for allphot in allphotdata%}
													<tr>
														<td>{{allphot.obs_date|date:"M d, Y H:i:s"}}</td>
														<td>{{allphot.mag}}</td>
														<td>{{allphot.mag_err}}</td>
														<td>{{allphot.band.name}}</td>
														<td>{{allphot.band.instrument.name}}</td>
													<tr/>
												{%endfor%}
												</tbody>
											</table>

					</div>
					<div class="tab-pane" id="spectra_tab">
						<h4>Spectra for {{transient.name}}</h4>
					</div>
					<div class="tab-pane" id="hst_tab">
						<h4>HST Images for {{transient.name}}</h4>
						<table class="table table-bordered table-striped">
							<thead>
								<tr>
									<th>Date</th>
									<th>Filter</th>
									<th>Instrument</th>
									<th>Image</th>
								</tr>
							</thead>
							<tbody id="hst_image_list">
							</tbody>
						</table>
					</div>
					<div class="tab-pane" id="chandra_tab">
						<h4>Chandra Images for {{transient.name}}</h4>
						<h4 id="totalchandraexp">total exposure time<h4>
						<table class="table table-bordered table-striped">
							<thead>
								<tr>
									<th>Date</th>
									<th>Exp. Time</th>
									<th>Image</th>
								</tr>
							</thead>
							<tbody id="chandra_image_list">
							</tbody>
						</table>
					</div>
					<div class="tab-pane" id="gw_tab">
						<h4>GW Candidate Info</h4>
						<h4><a href="{{ gw_candidate.websniff_url }}" target="_blank">Websniff URL</a><h4>
						<table class="table table-bordered table-striped">
							<thead>
								<tr>
									<th>Date</th>
									<th>Telescope</th>
									<th>Filter</th>
									<th>DOPHOT Class</th>
									<th>Image</th>
								</tr>
							</thead>
							<tbody>
								{% for gw_image in gw_images %}
								<tr>
									<td>{{ gw_image.obs_date }}</td>
									<td>{{ gw_image.image_filter.instrument }}</td>
									<td>{{ gw_image.image_filter }}</td>
									<td>{{ gw_image.dophot_class }}</td>
									<td><img src="{{ gw_image.image_filename }}" style='width:500px' border="0"></td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<div class="tab-pane" id="comments_tab">
						<h4>Comments for {{transient.name}}</h4>
						{% for l in logs %}
						<b>{{ l.created_by }}: </b>{{l.comment }} ({{l.modified_date}} UT)<br>
						{% endfor %}
						<p id="add_comment_container"></p>
						<form id="add_transient_comment" action="{% url 'add_transient_comment' %}" method="post">

						<input type="hidden" id="transient_pk" value="{{ transient.id }}"/>
						{% csrf_token %}
						{% for hidden_field in form.hidden_fields %}
						{{ hidden_field }}
						{% endfor %}
						<br>
						<div class="form-group">

					    	<label>Add Comment:</label>
					    	{% render_field transient_comment_form.comment class+="form-control" %}
					    	<!--<input type="comment" class="form-control" id="comment">-->
						</div>
						<div class="form-group">
							<button type="submit" class="btn btn-block btn-primary btn-lg">Submit</button>
						</div>
					</form>
				</div>
			</div>
		</div>

	</div>

				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}

	<script type="text/javascript" src="//aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js" charset="utf-8"></script>

	<script src="{% static 'YSE_App/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
	<script src="{% static 'YSE_App/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
	<script type="text/javascript" src="https://mpld3.github.io/js/d3.v3.min.js"></script>
	<script type="text/javascript" src="https://mpld3.github.io/js/mpld3.v0.3.1.dev1.js"></script>
	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-1.3.4.min.js"></script>
	<script src="{% static 'YSE_App/bower_components/bootstrap-timepicker/js/bootstrap-timepicker.js' %}"></script>

	<script>

		$(function() {

			// initialize the external events
			function init_events(ele) {
				ele.each(function () {

					var eventObject = {
						title: $.trim($(this).text())
					}
					// store the Event Object in the DOM element so we can get to it later
					$(this).data('eventObject', eventObject)

					// make the event draggable using jQuery UI
					$(this).draggable({
						zIndex			: 1070,
						revert			: true,	// will cause the event to go back to its
						revertDuration	:0  //		original position after the drag
					})
				})
			}

			init_events($('#external-events div.external-event'))

			// Make target canvas draggable
			$("#associated-events").droppable({
				drop:function(e,source){

					$("#associated-events-list").append(source.draggable);
					// Now, get all associated events and PATCH transient with them
					var tag_ids = $("#associated-events-list").children("div").map(function() {return $(this).attr("data-tag_id")})

					var base_url = window.location.protocol + "//" + window.location.hostname
					var port = window.location.port
					if (port != "") {
						base_url = base_url + ":" + port
					}

					var tag_urls = []
					for (i=0; i< tag_ids.length; i++) {
						tag_urls.push(base_url + "{% url 'transienttag-list' %}" + tag_ids[i] + "/")
					}

					var transient_target = "{% url 'transient-detail' transient.id %}"
					var api_url = base_url + transient_target

					var patchData = { "tags": tag_urls }
					var jsonData = JSON.stringify(patchData)

					$.ajax({
						type: "PATCH",
						url: api_url,
						csrfmiddlewaretoken: "{{ csrf_token }}",
						data: jsonData,
						contentType: "application/json; charset=utf-8",
 						dataType: "json",
						success: function(data, textStatus, jqXHR) {
							if (textStatus == "success") {

							} else {
								alert("Transient Tag may not have been created -- please use YSE Admin and contact Dave C or David J.")
							}
						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {
							// alert("Transient Tag may not have been created -- please use YSE Admin and contact Dave C or David J.")
							alert("Error: " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
						}
					});

				}
			});

			/* ADDING EVENTS */
			var currColor = '#3c8dbc' //Red by default
			var currColorID = "1"
			//Color chooser button
			var colorChooser = $('#color-chooser-btn')
			$('#color-chooser > li > a').click(function (e) {
			  e.preventDefault()
			  //Save color
			  currColor = $(this).css('color')
			  currColorID = $(this).attr('data-color_id')
			  //Add color effect to button
			  $('#add-new-event').css({ 'background-color': currColor, 'border-color': currColor })
			})


			$('#add-new-event').click(function (e) {
			  e.preventDefault()
			  //Get value and make sure it is not null
			  var val = $('#new-event').val()
			  if (val.length == 0) {
				return
			  }

				var url_target = "{% url 'transienttag-list' %}"
				var color_target = "{% url 'webappcolor-list' %}" + currColorID + "/"

				var base_url = window.location.protocol + "//" + window.location.hostname
				var port = window.location.port
				var api_url = base_url + url_target
				var color_url = base_url + color_target

				if (port != "") {
					api_url = base_url + ":" + port + url_target
					color_url = base_url + ":" + port + color_target
				}

				var postData = { "name": val,
								"color": color_url }

			  $.ajax({
				  type: "POST",
				  url: api_url,
				  csrfmiddlewaretoken: "{{ csrf_token }}",
				  data: postData,
				  success: function(data, textStatus, jqXHR) {
					  if (textStatus == "success") {

						var tokens = data.url.split("/")
						var tag_id = tokens[tokens.length-2]

						  //Create events
						  var event = $('<div />')
						  event.css({
							'background-color': currColor,
							'border-color'    : currColor,
							'color'           : '#fff'
						  }).addClass('external-event').attr('data-tag_id', tag_id)
						  event.html(val)
						  $('#external-events').prepend(event)

						  //Add draggable funtionality
						  init_events(event)
						  //Remove event from text input
							$('#new-event').val('')

					  } else {
							//Remove event from text input
							$('#new-event').val('')
						  // transientStatusChangeErr()
						  alert("Transient Tag may not have been created -- please use YSE Admin and contact Dave C or David J.")
					  }
				  },
				  error: function(XMLHttpRequest, textStatus, errorThrown) {
						$('#new-event').val('')
						alert("Transient Tag may not have been created -- please use YSE Admin and contact Dave C or David J.")
					  // alert("Error: " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
					  //Remove event from text input
					
				  }
				});

			})

			$('#example1').DataTable({
				  'paging'      : false,
				  'lengthChange': false,
				  'searching'   : false,
				  'ordering'    : false,
				  'info'        : false,
				  'autoWidth'   : false
				})
			// $('#example2').DataTable({
			//   'paging'      : true,
			//   'lengthChange': false,
			//   'searching'   : false,
			//   'ordering'    : true,
			//   'info'        : true,
			//   'autoWidth'   : false
			// })

			var aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov:0.017, target: "{{transient.ra}} {{transient.dec}}"});

			$('#follow_date_range').daterangepicker({ 
				timePicker24Hour: true,
				timePicker: true, 
				timePickerIncrement: 1, 
				{% if followup_initial_dates %}
				startDate: '{{followup_initial_dates.0}}',
				endDate:'{{followup_initial_dates.1}}',
				{% endif %}
				format: 'MM/DD/YYYY HH:mm', 
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				} 
			});

			//$('#spec_obs_date').datetimepicker({
        	//	format: 'dd/MM/yyyy hh:mm:ss',
		    //    language: 'pt-BR'
      		//});

			//$('#spec_obs_date').datetimepicker({
				//timePicker24Hour: true,
				//timePicker: true, 
				//timePickerIncrement: 1, 
			//	format: 'yyyy-mm-dd HH:mm', 
			//});

			//$('#obs_date').timepicker({
				//timePicker24Hour: true,
				//timePicker: true, 
				//timePickerIncrement: 1, 
			//	format: 'MM/DD/YYYY', 
			//	locale: {
			//		format: 'MM/DD/YYYY'
			//	} 
			//});

			$('#obs_task_desired_picker').daterangepicker({ 
				timePicker24Hour: true,
				timePicker: true, 
				timePickerIncrement: 1, 
				singleDatePicker: true,
				format: 'MM/DD/YYYY HH:mm', 
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				} 
			});

			$('#obs_task_actual_picker').daterangepicker({ 
				timePicker24Hour: true,
				timePicker: true, 
				timePickerIncrement: 1, 
				singleDatePicker: true,
				format: 'MM/DD/YYYY HH:mm', 
				locale: {
					format: 'MM/DD/YYYY HH:mm'
				} 
			});
			// Clear initial value
			$('#obs_task_actual_picker').val('');

			// Initialize date	
			//date_picker = $('#spec_obs_date').data('datetimepicker')
			//date_picker.setDate(null)
			//$('#obs_date').val(date_picker.getDate())

			// Initialize daterange
			fdr_picker = $('#follow_date_range').data('daterangepicker')
			$('#valid_start').val(fdr_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			$('#valid_stop').val(fdr_picker.endDate.format("YYYY-MM-DD HH:mm:00"))

			// Intialize Desired Obs Date. Don't initialize Actual Obs Date...
			otd_picker = $('#obs_task_desired_picker').data('daterangepicker')
			$('#desired_obs_date').val(otd_picker.startDate.format("YYYY-MM-DD HH:mm:00"))

			//Respond to daterange change events
			$('#obs_task_desired_picker').on('apply.daterangepicker', function(ev, picker) {
				$('#desired_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			});
			$('#obs_task_actual_picker').on('apply.daterangepicker', function(ev, picker) {
				$('#actual_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
			});
			$('#follow_date_range').on('apply.daterangepicker', function(ev, picker) {
				$('#valid_start').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
				$('#valid_stop').val(picker.endDate.format("YYYY-MM-DD HH:mm:00"))
			});
			$('#spec_obs_date').on('apply.datetimepicker', function(ev, picker) {
				$('#obs_date').getDate()
			});

			// Submit comment on submit
			$('#add_transient_comment').on('submit', function(event){
				event.preventDefault();
				add_transient_comment();
			});

			function add_transient_comment(){
				var data = $('#add_transient_comment').serialize()
				var transient_id = $('#transient_pk').val()
				data = (data + "&transient=" + transient_id)
				$.ajax({
					url : "{% url 'add_transient_comment' %}", // the endpoint
					type : "POST", // http method
					data : data, // data sent with the post request

					// handle a successful response
					success : function(json) {
						if (json.data['comment']){
							// Construct HTML to append container
							var commentHTML = "<b>"+json.data['created_by'] + ": </b>" + json.data['comment'] + " (" + json.data['modified_date'] + " UT)<br>"

							$("#add_comment_container").append(commentHTML)
							}
							// Close & reset form box
						$('#add_transient_comment')[0].reset();

					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						alert(xhr.status + ": " + xhr.responseText);
					}
				});
			};
		
		
			// Submit post on submit
			$('#add_transient_followup').on('submit', function(event){
				event.preventDefault();
				add_transient_followup();
			});

			function ChangeErr() {
				alert("Transient Status may not have changed -- please use YSE Admin and contact Dave C or David J.")
			}

			$('.transientStatusChange').on('click', function(event){
				var status_id = $(this).attr('data-status_id')
				var url_target = "{% url 'transient-detail' transient.id %}"
				var status_target = "{% url 'transientstatus-list' %}" + status_id + "/"

				var base_url = window.location.protocol + "//" + window.location.hostname
				var port = window.location.port
				var api_url = base_url + url_target
				var status_url = base_url + status_target

				if (port != "") {
					api_url = base_url + ":" + port + url_target
					status_url = base_url + ":" + port + status_target
				}

				var putData = { "status": status_url }

				$.ajax({
				  type: "PATCH",
				  url: api_url,
				  csrfmiddlewaretoken: "{{ csrf_token }}",
				  data: putData,
				  success: function(data, textStatus, jqXHR) {
					  if (jqXHR.status == 200 && textStatus == "success") {

						  var tokens = data.status.split("/")
						  var status_name = tokens[tokens.length-2]
						  $('#transient_status_name').text(status_name)
						  
						  //alert(status_url)
					  } else {
						  transientStatusChangeErr()
					  }
				  },
				  error: function(XMLHttpRequest, textStatus, errorThrown) {
					  transientStatusChangeErr()
					  {#alert("Error: " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));#}
				  }
				});
			});


			$('.specPlotChange').on('click', function(event){
				var spec_id = $(this).attr('spec_plot-id')
				var transient_id = {{transient.id}}		
				url = "{% url 'spectrumplotsingle' -1 -2 %}".replace('-1', transient_id).replace('-2',spec_id);
				$.get(url).done(function(htmlresponse){
					var lastNode = $("#specplot").children().last();
	            	lastNode.prev().remove();

					var rows = $("#specplot")
	  				$(rows).html(htmlresponse)
				});
			});

			$('.plotSALT2').on('click', function(event){
				//var spec_id = $(this).attr('spec_plot-id')
				//var transient_id = {{transient.id}}		
				var buttontext = $("#salt2plot").html();
				var mybutton = "hi";
				//$(".plotSALT2").html(buttontext);
				//$(".plotSALT2").html("Hide SALT2 Fit");
				if (buttontext.indexOf("Show") > -1){
					url = "{% url 'salt2plot' transient.id 1 %}";
					$.get(url).done(function(htmlresponse){
						var lastNode = $("#lcplot").children().last();
	        	    	lastNode.prev().remove();

						var rows = $("#lcplot");
	  					$(rows).html(htmlresponse);

	  					$(".plotSALT2").html("Hide SALT2 Fit");
	  				});
	  			} else {
	  				url = "{% url 'salt2plot' transient.id 0 %}";
					$.get(url).done(function(htmlresponse){
						var lastNode = $("#lcplot").children().last();
	        			lastNode.prev().remove();

						var rows = $("#lcplot");
	  					$(rows).html(htmlresponse);

	  					$(".plotSALT2").html("Show SALT2 Fit");
	  				});
				}
			});

			$('.plotAirmass').on('click', function(event){
				//var spec_id = $(this).attr('spec_plot-id')
				var transient_id = {{transient.id}};
				var telescope_id = $(this).attr('telescope_id');
				var resource_id = $(this).attr('resource_id');
				var obsnight_id = $(this).attr('obsnight_id');
				//<td><button id="airmass_plot">Show Plot</button></td>
				
                var urltext = "<img src='{% url 'airmassplot' -1 -2 -3 %}' width='240' alt='' /><br>".replace('-1',transient_id).replace('-2',obsnight_id).replace('-3',telescope_id);
                //urltext = urltext
                //transient.id 0 too_resource.telescope.id
                //.replace('-1', transient_id).replace('-2',spec_id)
                //too_resource.telescope.id
				var lastNode = $("#airmass_plot_table_"+obsnight_id+"_"+resource_id).children().last();
	        	lastNode.prev().remove();

				var rows = $("#airmass_plot_table_"+obsnight_id+"_"+resource_id);
	  			$(rows).html(urltext);
			});

			function ToggleObservationTaskForm(followup_id,expand)
			{
				if (expand) {
					//Set the hidden follow-up field in the form
					$('#observation_task_followup_pk').val(followup_id);
					
					//Enable the form
					$('#add_transient_observation_task_fieldset').attr('disabled', false)

					//Clear old messages & set new messages
					$('#add_transient_observation_task_info > ul').empty();
					$("#add_transient_observation_task_info ul").append("<li>Adding task for <b>Follow-up (id: " + followup_id + ")</b></li>");

					//Toggle message divs
					$("#add_transient_observation_task_warning").hide();
					$("#add_transient_observation_task_info").show();

					//If the form is hidden, show the form
					if ($("#add_transient_observation_task_btn").parent().parent().parent().hasClass('collapsed-box')) {
						$("#add_transient_observation_task_btn").trigger("click")
					}
				} else {
					//Toggle message divs
					$("#add_transient_observation_task_warning").show();
					$("#add_transient_observation_task_info").hide();

					//Clear old messages
					$('#add_transient_observation_task_info > ul').empty();

					//Disable the form
					$('#add_transient_observation_task_fieldset').attr('disabled', true)

					//Unset the hidden follow-up field in the form
					$('#observation_task_followup_pk').val("");
				}
			}

			$("#add_transient_observation_task_btn").on('click',function(event){
				//If the form is hidden, show the form
				if (!$("#add_transient_observation_task_btn").parent().parent().parent().hasClass('collapsed-box')) {
					ToggleObservationTaskForm("",false);
				}
			});

			$('.add_task').on('click', function(event){
				event.preventDefault();
				var followup_id = $(this).attr('followup_id');
				ToggleObservationTaskForm(followup_id,true)
			});

			$('.followup_edit').on('click', function(event){
				event.preventDefault();
				var followup_id = $(this).attr('followup_id');

				//Set all form fields
				//Expose form
				alert("Edit: " + followup_id + "!");
			});

			$('#add_transient_observation_task').on('submit', function(event){
				event.preventDefault();
				add_transient_observation_task();
			});

			function add_transient_observation_task() {
				//Serialize the form data and make POST
				var data = $('#add_transient_observation_task').serialize()
				var followup_id = $('#observation_task_followup_pk').val()
				data = (data + "&followup=" + followup_id)

				$.ajax({
					url : "{% url 'add_transient_observation_task' %}", // the endpoint
					type : "POST", // http method
					data : data, // data sent with the post request

					// handle a successful response
					success : function(json) {
						
						// Required fields
						var obs_task_pk = json.data["id"]
						var status_id = json.data["status_id"]
						var status_name = json.data["status_name"]
						var instrument_config = json.data["instrument_config"]
						var exposure_time = json.data["exposure_time"]
						var number_of_exposures = json.data["number_of_exposures"]
						var desired_obs_date = json.data["desired_obs_date"]
						var observatory = json.data["observatory"]
						var telescope = json.data["telescope"]
						var instrument = json.data["instrument"]
						var config_eles = json.data["config_eles"]
						var modified_by = json.data["modified_by"]

						if (!obs_task_pk || !status_id || !status_name ||
							!instrument_config || !exposure_time || !number_of_exposures || !desired_obs_date || !observatory || !telescope || !instrument || !modified_by || !config_eles) {
							alert("Required fields for `Transient Observation Task` not found! Please contact administrator. Exiting...")
							throw "Missing required fields from ``AddTransientObservationTaskFormView"
						}

						var actual_obs_date = json.data["actual_obs_date"] ? json.data["actual_obs_date"] : "None"
						var description = json.data["description"] ? json.data["description"] : ""

						// Construct HTML to append container
						var taskHTML = "<tr>" +
							"<td>" + obs_task_pk + "</td>" + 
							"<td>" + observatory + "</td>" + 
							"<td>" + telescope + "</td>" + 
							"<td>" + instrument + "</td>" +
							"<td>" + desired_obs_date + "</td>" +
							"<td>" + actual_obs_date + "</td>" +
							"<td>" + exposure_time + "</td>" + 
							"<td>" + description + "</td>" +
							"<td>" + number_of_exposures + "</td>" + 
							"<td>" + instrument_config + "</td>" + 
							"<td>" + config_eles + "</td>" + 
							"<td>" + status_name + "</td>" + 
							"<td>" + modified_by + "</td>" + 
							"<td><a target='_blank' href='{% url 'admin:YSE_App_transientobservationtask_changelist' %}" + obs_task_pk + "/change/'>Edit</a></td>" +
							"</tr>"

							var rows = $("#tbl_obs_followup_" + followup_id + " > tbody")
							$(rows).prepend(taskHTML)

							//Append the hidden followup field to the payload
							//Parse and write data to correct grid
							//Disable form
							//Remove info-text and restore warning text
							//Minimize form
							//Clear form fields

							// Close & reset form box
							$("#add_transient_observation_task_btn").trigger("click")
							$('#add_transient_observation_task')[0].reset();

							// Re-initialize the datepicker
							$('#desired_obs_date').val("")
							$('#actual_obs_date').val("")
							$('#obs_task_desired_picker').daterangepicker({ 
								timePicker24Hour: true,
								timePicker: true, 
								timePickerIncrement: 1, 
								singleDatePicker: true,
								format: 'MM/DD/YYYY HH:mm', 
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});
							$('#obs_task_actual_picker').daterangepicker({ 
								timePicker24Hour: true,
								timePicker: true, 
								timePickerIncrement: 1, 
								singleDatePicker: true,
								format: 'MM/DD/YYYY HH:mm', 
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});

							// Re-Initialize daterange
							otd_picker = $('#obs_task_desired_picker').data('daterangepicker')
							$('#desired_obs_date').val(otd_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							// Clear initial value for optional field
							$('#obs_task_actual_picker').val('');

							$('#obs_task_desired_picker').on('apply.daterangepicker', function(ev, picker) {
								$('#desired_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							});
							$('#obs_task_actual_picker').on('apply.daterangepicker', function(ev, picker) {
								$('#actual_obs_date').val(picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							});
					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						alert(xhr.status + ": " + xhr.responseText);
						}
					});
			}

			function add_transient_followup() {
				// Grab the form, and associate it with the current transient detail page
				var data = $('#add_transient_followup').serialize()
				var transient_id = $('#transient_pk').val()
				data = (data + "&transient=" + transient_id)

				$.ajax({
					url : "{% url 'add_transient_followup' %}", // the endpoint
					type : "POST", // http method
					data : data, // data sent with the post request

					// handle a successful response
					success : function(json) {
						
						// Required fields
						var followup_pk = json.data["id"]
						var status_id = json.data["status_id"]
						var status_name = json.data["status_name"]
						var valid_start = json.data["valid_start"]
						var valid_stop = json.data["valid_stop"]
						var modified_by = json.data["modified_by"]

						if (!followup_pk || !status_id || !status_name ||
							!valid_start || !valid_stop || !modified_by) {
							alert("Required fields for `Transient Followup` not found! Please contact administrator. Exiting...")
							throw "Missing required fields from ``AddTransientFollowupFormView"
						}

						var too_resource = json.data["too_resource"]
						var classical_resource = json.data["classical_resource"]
						var queued_resource = json.data["queued_resource"]

						var spec_priority = json.data["spec_priority"] ? json.data["spec_priority"] : "None"
						var phot_priority = json.data["phot_priority"] ? json.data["phot_priority"] : "None"
						var offset_star_ra = json.data["offset_star_ra"] ? json.data["offset_star_ra"] : "None"
						var offset_star_dec = json.data["offset_star_dec"] ? json.data["offset_star_dec"] : "None"
						var offset_north = json.data["offset_north"] ? json.data["offset_north"] : "None"
						var offset_east = json.data["offset_east"] ? json.data["offset_east"] : "None"
						var comment = json.data["comment"] ? json.data["comment"] : "None"

						// Construct date strings
						var start_date = new Date(valid_start)
						var end_date = new Date(valid_stop)
						var start_date_str = start_date.getUTCMonth() + "/" + start_date.getUTCDate() + "/" + start_date.getUTCFullYear()
						var end_date_str = end_date.getUTCMonth() + "/" + end_date.getUTCDate() + "/" + end_date.getUTCFullYear()

						// Construct associated resources
						var associated_resouces = "";
						if (too_resource) {
							associated_resouces = (associated_resouces + too_resource + "<br>")
						}
						if (classical_resource) {
							associated_resouces = (associated_resouces + classical_resource + "<br>")
						}
						if (queued_resource) {
							associated_resouces = (associated_resouces + queued_resource)
						}

						// Construct HTML to append container
						var followupHTML = "<div class='col-xs-12'>" +
							"<div class='followupbox box box-primary'>" +
							"<div class='box-header'>" + 
							"<div class='col-xs-4'>" + 
							"<h3 class='box-title'>Follow-up (id: " + followup_pk + ")</h3>" + 
							"</div>" +
							"<div class='col-xs-4'>" + 
							"<h3 class='box-title'>Valid: " + start_date_str + " - " + end_date_str + "</h3>" + 
							"</div>" +
							"<div class='col-xs-4'>" + 
							"<h3 style='float:right;padding-right:10px' class='box-title'>Last Modified: " + modified_by + "</h3>" + 
							"</div>" +
							"<div class='box-tools pull-right'>" +
							"<button type='button' class='btn btn-box-tool' data-widget='collapse'><i class='fa fa-minus'></i></button>" +
							"</div>" + 
							"</div>" + 
							"<div class='box-body'>" + 
							"<table id='tbl_followup_" + followup_pk + "' class='table table-bordered table-striped'>" +
							"<thead><tr><th>Spec. Priority</th><th>Phot. Priority</th><th>Offset Star<br>RA</th><th>Offset Star<br>DEC</th><th>Offset North</th><th>Offset East</th><th>Attached Resource</th><th>Status</th><th>Action</th></tr></thead>" + 
							"<tbody><tr>" + 
							"<td>" + spec_priority + "</td>" +
							"<td>" + phot_priority + "</td>" +
							"<td>" + offset_star_ra + "</td>" +
							"<td>" + offset_star_dec + "</td>" +
							"<td>" + offset_north + "</td>" +
							"<td>" + offset_east + "</td>" +
							"<td>" + associated_resouces + "</td>" + 
							"<td>" + status_name + "</td>" + 
							"<td>" + comment + "</td>" +
							"<td><a target='_blank' href='{% url 'admin:YSE_App_transientfollowup_changelist' %}" + followup_pk + "/change/'>Edit</a></td>" + 
							"</tr></tbody></table><hr>" + 
							"<h4 class='box-title'>Observation Tasks</h4>" + 
							"<table id='tbl_obs_followup_" + followup_pk + "' class='table table-bordered table-striped'>" +
							"<thead><tr>" +
							"<th>ID</th>" + 
							"<th>Obs.</th>" + 
							"<th>Tel.</th>" +
							"<th>Inst.</th>" +
							"<th>Desired Obs.<br>Date (UTC)</th>" +
							"<th>Actual Obs.<br>Date (UTC)</th>" +
							"<th>Exp.<br>Time</th>" +
							"<th>Desc.</th>" +
							"<th># of<br>Exposures</th>" +
							"<th>Config. Name</th>" +
							"<th>Config. Detail</th>" +
							"<th>Status</th>" +
							"<th>Last<br>Modified By</th>" +
							"<th>Action</th>" +
							"</tr></thead>" + 
							"<tbody><tr><td colspan='13'></td><td><b><a class='add_task' followup_id='" + followup_pk + "' href='#'>Add</a></b></td></tr>" + 
							"</tbody></table><br></div></div></div>"

							var container_collection = $("#followup_container > div")
							if (container_collection.length == 0) {
								$("#followup_container").append(followupHTML)
							} else {
								$("#followup_container").prepend(followupHTML)
							}

							// Close & reset form box
							$("#add_transient_followup_btn").trigger("click")
							$('#add_transient_followup')[0].reset();

							// Re-initialize the datepicker
							$('#valid_start').val("")
							$('#valid_stop').val("")
							$('#follow_date_range').daterangepicker({ 
								timePicker24Hour: true,
								timePicker: true, 
								timePickerIncrement: 1, 
								format: 'MM/DD/YYYY HH:mm', 
								locale: {
									format: 'MM/DD/YYYY HH:mm'
								}
							});

							// Re-Initialize daterange
							fdr_picker = $('#follow_date_range').data('daterangepicker')
							$('#valid_start').val(fdr_picker.startDate.format("YYYY-MM-DD HH:mm:00"))
							$('#valid_stop').val(fdr_picker.endDate.format("YYYY-MM-DD HH:mm:00"))

							// Re-wire widget behavior
							$('.followupbox').boxWidget()
							$('.add_task').on('click', function(event){
								event.preventDefault();
								var followup_id = $(this).attr('followup_id');
								ToggleObservationTaskForm(followup_id,true)
							});
					},

					// handle a non-successful response
					error : function(xhr,errmsg,err) {
						alert(xhr.status + ": " + xhr.responseText);
					}
				});
			};

			// This function gets cookie with a given name
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}

			var csrftoken = getCookie('csrftoken');

			/*
			The functions below will create a header with csrftoken
			*/

			function csrfSafeMethod(method) {
				// these HTTP methods do not require CSRF protection
				return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}

			function sameOrigin(url) {
				// test that a given url is a same-origin URL
				// url could be relative or scheme relative or absolute
				var host = document.location.host; // host + port
				var protocol = document.location.protocol;
				var sr_origin = '//' + host;
				var origin = protocol + sr_origin;
				// Allow absolute or scheme relative URLs to same origin
				return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
				(url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
					// or any other URL that isn't scheme relative or absolute i.e relative.
					!(/^(\/\/|http:|https:).*/.test(url));
				}

				$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
						// Send the token to same-origin, relative URLs only.
						// Send the token only if the method warrants CSRF protection
						// Using the CSRFToken value acquired earlier
						xhr.setRequestHeader("X-CSRFToken", csrftoken);
						}
					}
				});
			});
		//});

	  $( document ).ready(function(){
	  	$.get("{% url 'get_ps1_image' transient.id %}").done(function(json){
	  	var rows = $("#ps1_image")
	  	if (json["jpegurl"]) {
	  	htmltext = "<a href=\"http://ps1images.stsci.edu/cgi-bin/ps1cutouts?pos={{ transient.ra }}%2B{{ transient.dec }}&amp;filter=color\" class=\"ps1-thumb\" title=\"Link to PanSTARRS-1\" target=\"_blank\"><img src=\"" + json["jpegurl"] + "\" style='width:240px' alt=\"\" /></a>"
		  } else {
		  var htmltext = "<p class=\"text-muted\">Coordinates are outside the PS1 footprint</p>"
	  	}
	  
		  $(rows).append(htmltext)
		});

		$.get("{% url 'get_hst_image' transient.id %}").done(function(json){
			var rows = $("#hst_image")
  			var rows_full = $("#hst_image_list")
  			var rows_tab = $("#hst_tab_header")
  			var htmltext = "<p class=\"text-muted\">No HST Images available</p>"
	  		if (json.jpegurl[0]) {
	  			var htmltext = "<img src=\"" + json.jpegurl[0] + "\" style='width:240px' alt=\"\" /></a>"

	  		} else {
				var headertext = "No "
				$(rows_tab).prepend(headertext)
			}
			$(rows).append(htmltext)

	  		for(var ju in json.jpegurl){
				var htmltextfull = "<tr>" + 
				"<td>" + json.obsdate[ju] + "</td>" + 
				"<td>" + json.filters[ju] + "</td>" +
				"<td>" + json.inst[ju] + "</td>" + 
				"<td><a href='" + json.fitsurl[ju] + "' target='_blank'><img src='" + json.jpegurl[ju] + "' style='width:240px' alt='' /></a></td>" //+ 
				"</tr>"
				$(rows_full).append(htmltextfull)
	  		}
	  	});
		$.get("{% url 'get_chandra_image' transient.id %}").done(function(json){
			var rows = $("#chandra_image")
  			var rows_full = $("#chandra_image_list")
  			var rows_exp = $("#totalchandraexp")
  			var rows_tab = $("#chandra_tab_header")
  			var htmltext = "<p class=\"text-muted\">No Chandra Images available</p>"
	  		if (json.jpegurl[0]) {
	  			var htmltext = "<img src=\"" + json.jpegurl[0] + "\" style='width:240px' alt=\"\" /></a>"

	  		} else {
				var headertext = "No "
				$(rows_tab).prepend(headertext)
			}
			$(rows).append(htmltext)

	  		for(var ju in json.jpegurl){
				var htmltextfull = "<tr>" + 
				"<td>" + json.obsdate[ju] + "</td>" + 
				"<td>" + json.exptime[ju] + "</td>" + 
				"<td><a href='" + json.fitsurl[ju] + "' target='_blank'><img src='" + json.jpegurl[ju] + "' style='width:240px' alt='' /></a></td>" + 
				"</tr>"
				$(rows_full).append(htmltextfull)
	  		}
	  		$(rows_exp).prepend(json.totalexp+"s ")
	  	});

	  	$.get("{% url 'get_legacy_image' transient.id %}").done(function(json){
			var rows = $("#legacy_image")

	  		var htmltext = "<a href="+json.fitsurl+"><img src=\"" + json.jpegurl + "\" style='width:240px' alt=\"\" /></a>"

			$(rows).append(htmltext)
		});

		$.get("{% url 'spectrumplot' transient.id %}").done(function(htmlresponse){
			var rows = $("#specplot");
	  		$(rows).html(htmlresponse);
	  	});

		$.get("{% url 'lightcurveplot_detail' transient.id %}").done(function(htmlresponse){
	  		$("#lcplot").html(htmlresponse);
	  	});

	  	//$.get("{% url 'lightcurveplot_detail' transient.id %}").done(function(htmlresponse){
	  	//	
	  	//	$("#biglcplot").html(htmlresponse.replace("width: 500px; height: 400px;","width: 1000px; height: 800px;"));
	  	//});

	  {% for obsnight in observing_nights %}
          $.get("{% url 'rise_time' transient.id obsnight.id %}").done(function(json){
          var rows = $("#rise_time_{{obsnight.id}}")
          $(rows).append(json["rise_time"])
          });
          $.get("{% url 'set_time' transient.id obsnight.id %}").done(function(json){
          var rows = $("#set_time_{{obsnight.id}}")
          $(rows).append(json["set_time"])
          });
          $.get("{% url 'moon_angle' transient.id obsnight.id %}").done(function(json){
          var rows = $("#moon_angle_{{obsnight.id}}")
          $(rows).append(json["moon_angle"])
          });
	  {% endfor %}

	  {% for too_resource in too_resource_list %}
          {% if too_resource.used_too_hours < too_resource.awarded_too_hours %}

              $.get("{% url 'tonight_rise_time' transient.id too_resource.id %}").done(function(json){
                  var rows = $("#tonight_rise_time_{{too_resource.id}}")
                  $(rows).append(json["rise_time"])
              });

              $.get("{% url 'tonight_set_time' transient.id too_resource.id %}").done(function(json){
                  var rows = $("#tonight_set_time_{{too_resource.id}}")
                  $(rows).append(json["set_time"])
              });

              $.get("{% url 'tonight_moon_angle' transient.id too_resource.id %}").done(function(json){
                  var rows = $("#tonight_moon_angle_{{too_resource.id}}")
                  $(rows).append(json["moon_angle"])
              });

              $.get("{% url 'delta_too_hours' too_resource.id %}").done(function(json){
                  var rows = $("#delta_too_hours_{{too_resource.id}}")
                  $(rows).append(json["delta_too_hours"])
              });
          {% endif %}
	  {% endfor %}
	  });
//});
				
	</script>
{% endblock %}
